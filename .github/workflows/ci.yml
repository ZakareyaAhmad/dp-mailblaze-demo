name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:

  python_lint:
    name: python_lint (ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Ruff lint
        run: ruff check .

  python_format_check:
    name: python_format_check (ruff format --check)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Ruff format check
        run: ruff format --check .

  terraform_validate:
    name: terraform_validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3

      - name: Terraform fmt
        run: terraform -chdir=infra/terraform fmt -check -recursive

      - name: Terraform init (no backend)
        run: terraform -chdir=infra/terraform init -backend=false

      - name: Terraform validate
        run: terraform -chdir=infra/terraform validate

  dbt_compile:
    name: dbt_compile (offline)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dbt
        run: |
          python -m pip install --upgrade pip
          pip install dbt-core dbt-snowflake

      - name: dbt deps
        run: dbt deps --project-dir dbt --profiles-dir .github/ci_profiles

      - name: dbt parse
        run: dbt parse --project-dir dbt --profiles-dir .github/ci_profiles

  docker_build:
    name: docker_build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dockerfile:
          - ingest/Dockerfile
          - orchestration/prefect/Dockerfile
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Build image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: false