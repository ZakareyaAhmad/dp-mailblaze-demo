name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  python_lint:
    name: python_lint (ruff)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Ruff lint (ingest + orchestration)
        run: |
          ruff check ingest orchestration

  python_format_check:
    name: python_format_check (ruff format --check)
    runs-on: ubuntu-latest
    needs: [python_lint]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Ruff format check
        run: |
          ruff format --check ingest orchestration

  terraform_validate:
    name: terraform_validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.5"

      - name: terraform fmt -check
        working-directory: infra/terraform
        run: terraform fmt -check -recursive

      - name: terraform init (no backend)
        working-directory: infra/terraform
        run: terraform init -backend=false

      - name: terraform validate
        working-directory: infra/terraform
        run: terraform validate

  dbt_compile:
    name: dbt_compile (deps + parse, no Snowflake required)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dbt (snowflake adapter)
        run: |
          python -m pip install --upgrade pip
          pip install "dbt-snowflake==1.8.4"

      - name: Cache dbt packages
        uses: actions/cache@v4
        with:
          path: |
            dbt/dbt_packages
            dbt/logs
            dbt/target
          key: ${{ runner.os }}-dbt-${{ hashFiles('dbt/packages.yml') }}
          restore-keys: |
            ${{ runner.os }}-dbt-

      - name: dbt deps
        working-directory: dbt
        run: dbt deps

      - name: dbt parse (CI dummy profile)
        working-directory: dbt
        run: |
          dbt parse \
            --profiles-dir ../.github/dbt_profiles \
            --target ci

  docker_build:
    name: docker_build (ingest + prefect)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build ingest image
        run: |
          test -f ingest/Dockerfile
          docker build -t dp-mailblaze-demo-ingest:ci ./ingest

      - name: Build prefect/orchestration image (if Dockerfile exists)
        run: |
          if test -f orchestration/prefect/Dockerfile; then
            docker build -t dp-mailblaze-demo-prefect:ci ./orchestration/prefect
          else
            echo "No orchestration/prefect/Dockerfile found; skipping prefect image build."
          fi